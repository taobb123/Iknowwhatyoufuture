import{j as o,n as q,b as H,i as K,u as O,r as i,o as J,E as Q,l as j,m as V}from"./index-Du8BMbyU.js";import{i as W,e as X,a as Y,u as Z,c as _,d as ee}from"./databaseArticleManager-BChPH7IT.js";import{P as oe}from"./ProtectedRoute-Cy_wGfBG.js";import{S as se,R as re}from"./RichTextEditor-BUM970cM.js";import{M as te}from"./MarkdownRenderer-uREq-bPp.js";import{A as le}from"./arrow-left-gJmRVtYo.js";import{T as ae}from"./trash-2-CNoFtxfl.js";import"./code-BYXChO7U.js";import"./list-wXdPW-X7.js";const ce=()=>{const{id:a}=q(),m=H(),{state:d,getUserDisplayName:z}=K(),{currentTheme:s}=O(),[x,k]=i.useState(null),[t,g]=i.useState({title:"",content:"",category:"前端开发",tags:[],status:"draft"}),[v,N]=i.useState(""),[y,D]=i.useState(!1),[U,f]=i.useState(!0),[h,w]=i.useState(!1),[p,T]=i.useState(!1),[P,C]=i.useState(!1),[R,S]=i.useState([]);i.useEffect(()=>{(async()=>{try{if(await W(),a)setTimeout(async()=>{try{await I(),await A()}catch(r){console.error("加载文章和分类失败:",r),f(!1)}},100);else try{await A(),f(!1)}catch(r){console.error("加载分类失败:",r),f(!1)}}catch(r){console.error("初始化数据失败:",r),f(!1)}})()},[a]);const I=async()=>{if(a)try{const e=await X(a);e?(k(e),g({title:e.title,content:e.content,category:e.category,tags:e.tags,status:e.status})):(console.error("文章不存在:",a),n("文章不存在","error"),m("/article-management"))}catch(e){console.error("加载文章失败:",e),n("加载文章失败","error"),m("/article-management")}finally{f(!1)}},A=async()=>{try{const e=await Y();S(e)}catch(e){console.error("加载分类失败:",e),S(["前端开发","后端开发","游戏攻略","技术讨论"])}},G=async()=>{var e,r,c;if(!t.title.trim()||!t.content.trim()){n("请填写标题和内容！","error");return}if(!a&&!j()&&((e=d.user)==null?void 0:e.isGuest)&&!V()){n("当前系统设置禁止游客匿名发表文章，请先注册账户！","error");return}w(!0);try{let l=null;if(a&&x)console.log("更新文章:",a,t),l=await Z(a,t),console.log("更新结果:",l);else{const u=z(),b=j();console.log("创建文章:",{...t,author:u}),l=await _({...t,author:u,authorId:b?b.id:(r=d.user)==null?void 0:r.id,authorType:b?"regular":((c=d.user)==null?void 0:c.userType)||"guest",likes:0,views:0,comments:0}),console.log("创建结果:",l)}l?(k(l),n("文章保存成功！","success"),setTimeout(()=>{var M,L;const u=j(),b=((M=d.user)==null?void 0:M.role)==="admin"||((L=d.user)==null?void 0:L.role)==="superAdmin";m(u||!b?"/game-hub":"/article-management")},2e3)):(console.error("保存失败：savedArticle为null或undefined"),n("保存失败，请重试！","error"))}catch(l){console.error("保存文章时发生错误:",l),n("保存失败，请重试！","error")}finally{w(!1)}},F=async()=>{if(a){T(!0);try{await ee(a)?(n("文章删除成功！","success"),setTimeout(()=>{var l,u;const r=j(),c=((l=d.user)==null?void 0:l.role)==="admin"||((u=d.user)==null?void 0:u.role)==="superAdmin";m(r||!c?"/game-hub":"/article-management")},2e3)):n("删除失败，请重试！","error")}catch{n("删除失败，请重试！","error")}finally{T(!1),C(!1)}}},E=()=>{v.trim()&&!t.tags.includes(v.trim())&&(g(e=>({...e,tags:[...e.tags,v.trim()]})),N(""))},$=e=>{g(r=>({...r,tags:r.tags.filter(c=>c!==e)}))},B=()=>{var c,l;if((t.title.trim()||t.content.trim())&&(a&&x?t.title!==x.title||t.content!==x.content||t.category!==x.category:t.title.trim()!==""||t.content.trim()!=="")&&!window.confirm("您有未保存的更改，确定要离开吗？"))return;const e=j(),r=((c=d.user)==null?void 0:c.role)==="admin"||((l=d.user)==null?void 0:l.role)==="superAdmin";m(e||!r?"/game-hub":"/article-management")},n=(e,r)=>{const c=document.createElement("div");c.innerHTML=`
      <div style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${r==="success"?"#10B981":"#EF4444"};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 14px;
        font-weight: 500;
      ">
        ${r==="success"?"✅":"❌"} ${e}
      </div>
    `,document.body.appendChild(c),setTimeout(()=>{c.remove()},3e3)};return U?o.jsx("div",{className:"min-h-screen text-white flex items-center justify-center",style:{backgroundColor:s.colors.background},children:o.jsxs("div",{className:"text-center",children:[o.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 mx-auto mb-4",style:{borderColor:s.colors.primary}}),o.jsx("p",{style:{color:s.colors.text},children:"加载中..."})]})}):o.jsxs("div",{className:"min-h-screen text-white",style:{backgroundColor:s.colors.background},children:[o.jsx("div",{className:"pt-16"}),o.jsx("div",{className:"border-b px-4 sm:px-6 py-4 sticky top-16 z-40",style:{backgroundColor:s.colors.surface,borderColor:s.colors.border},children:o.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[o.jsxs("div",{className:"flex items-center gap-4",children:[o.jsxs("button",{onClick:B,className:"flex items-center gap-2 px-3 sm:px-4 py-2 text-white rounded-lg transition-all duration-200 hover:scale-105",style:{backgroundColor:s.colors.secondary},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=s.colors.hover},onMouseLeave:e=>{e.currentTarget.style.backgroundColor=s.colors.secondary},children:[o.jsx(le,{size:18}),o.jsx("span",{className:"hidden sm:inline",children:"返回"})]}),o.jsx("div",{className:"flex items-center gap-3",children:o.jsx("h1",{className:"text-lg sm:text-xl font-semibold",style:{color:s.colors.text},children:a&&x?"编辑文章":"创建文章"})})]}),o.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[o.jsxs("button",{onClick:()=>D(!y),className:"flex items-center gap-1 sm:gap-2 px-3 sm:px-4 py-2 text-white rounded-lg transition-all duration-200 hover:scale-105",style:{backgroundColor:y?s.colors.primary:s.colors.secondary},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=s.colors.hover},onMouseLeave:e=>{e.currentTarget.style.backgroundColor=y?s.colors.primary:s.colors.secondary},children:[y?o.jsx(J,{size:16}):o.jsx(Q,{size:16}),o.jsx("span",{className:"hidden sm:inline",children:y?"编辑":"预览"})]}),o.jsx("button",{onClick:G,disabled:h,className:"flex items-center gap-1 sm:gap-2 px-4 sm:px-6 py-2 text-white rounded-lg transition-all duration-200 hover:scale-105 shadow-lg",style:{backgroundColor:h?s.colors.secondary:s.colors.success,cursor:h?"not-allowed":"pointer",opacity:h?.7:1},onMouseEnter:e=>{h||(e.currentTarget.style.backgroundColor=s.colors.hover)},onMouseLeave:e=>{h||(e.currentTarget.style.backgroundColor=s.colors.success)},children:h?o.jsxs(o.Fragment,{children:[o.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2",style:{borderColor:s.colors.text}}),o.jsx("span",{className:"hidden sm:inline",children:"保存中..."})]}):o.jsxs(o.Fragment,{children:[o.jsx(se,{size:16}),o.jsx("span",{className:"hidden sm:inline",children:"保存"})]})}),a&&x&&o.jsxs("button",{onClick:()=>C(!0),className:"flex items-center gap-1 sm:gap-2 px-3 sm:px-4 py-2 text-white rounded-lg transition-all duration-200 hover:scale-105 shadow-lg",style:{backgroundColor:s.colors.error},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=s.colors.hover},onMouseLeave:e=>{e.currentTarget.style.backgroundColor=s.colors.error},children:[o.jsx(ae,{size:16}),o.jsx("span",{className:"hidden sm:inline",children:"删除"})]})]})]})}),o.jsx("div",{className:"container mx-auto px-6 py-8",children:o.jsxs("div",{className:"max-w-5xl mx-auto",children:[o.jsx("div",{className:"rounded-lg p-6 mb-6 shadow-lg",style:{backgroundColor:s.colors.surface,borderColor:s.colors.border,border:"1px solid",boxShadow:s.shadows.lg},children:o.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[o.jsxs("div",{className:"md:col-span-2",children:[o.jsx("label",{className:"block text-sm font-medium mb-2",style:{color:s.colors.textSecondary},children:"文章标题"}),o.jsx("input",{type:"text",value:t.title,onChange:e=>g(r=>({...r,title:e.target.value})),className:"w-full px-4 py-3 rounded-lg text-white focus:outline-none",style:{backgroundColor:s.colors.background,borderColor:s.colors.border,border:"1px solid",color:s.colors.text},placeholder:"请输入文章标题"})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium mb-2",style:{color:s.colors.textSecondary},children:"分类"}),o.jsxs("select",{value:t.category,onChange:e=>g(r=>({...r,category:e.target.value})),className:"w-full px-4 py-3 rounded-lg text-white focus:outline-none",style:{backgroundColor:s.colors.background,borderColor:s.colors.border,border:"1px solid",color:s.colors.text},children:[o.jsx("option",{value:"",children:"选择分类"}),R.map(e=>o.jsx("option",{value:e,children:e},e))]})]}),o.jsxs("div",{children:[o.jsx("label",{className:"block text-sm font-medium mb-2",style:{color:s.colors.textSecondary},children:"状态"}),o.jsxs("select",{value:t.status,onChange:e=>g(r=>({...r,status:e.target.value})),className:"w-full px-4 py-3 rounded-lg focus:outline-none",style:{backgroundColor:s.colors.background,borderColor:s.colors.border,border:"1px solid",color:s.colors.text},children:[o.jsx("option",{value:"draft",children:"草稿"}),o.jsx("option",{value:"published",children:"已发布"})]})]}),o.jsxs("div",{className:"md:col-span-2",children:[o.jsx("label",{className:"block text-sm font-medium mb-2",style:{color:s.colors.textSecondary},children:"标签"}),o.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:t.tags.map(e=>o.jsxs("span",{className:"inline-flex items-center gap-1 px-3 py-1 text-sm rounded-full",style:{backgroundColor:`${s.colors.primary}20`,color:s.colors.primary},children:[e,o.jsx("button",{onClick:()=>$(e),className:"ml-1 hover:opacity-70 transition-opacity",style:{color:s.colors.textSecondary},children:"×"})]},e))}),o.jsxs("div",{className:"flex gap-2",children:[o.jsx("input",{type:"text",value:v,onChange:e=>N(e.target.value),onKeyPress:e=>e.key==="Enter"&&E(),className:"flex-1 px-4 py-2 rounded-lg focus:outline-none",style:{backgroundColor:s.colors.background,borderColor:s.colors.border,border:"1px solid",color:s.colors.text},placeholder:"添加标签，按回车确认"}),o.jsx("button",{onClick:E,className:"px-4 py-2 rounded-lg transition-colors",style:{backgroundColor:s.colors.primary,color:s.colors.text},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=s.colors.hover},onMouseLeave:e=>{e.currentTarget.style.backgroundColor=s.colors.primary},children:"添加"})]})]})]})}),o.jsxs("div",{className:"rounded-lg p-6",style:{backgroundColor:s.colors.surface,borderColor:s.colors.border,border:"1px solid",boxShadow:s.shadows.lg},children:[o.jsx("label",{className:"block text-sm font-medium mb-4",style:{color:s.colors.textSecondary},children:"文章内容"}),y?o.jsx("div",{className:"min-h-[400px] p-4 rounded-lg",style:{backgroundColor:s.colors.background},children:o.jsxs("div",{className:"prose prose-invert max-w-none",children:[o.jsx("h2",{className:"text-xl font-semibold mb-4",style:{color:s.colors.text},children:t.title||"无标题"}),o.jsx(te,{content:t.content||"暂无内容"})]})}):o.jsx(re,{value:t.content,onChange:e=>g(r=>({...r,content:e})),placeholder:"开始撰写您的文章内容...",className:"rounded-lg"})]})]})}),P&&o.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:o.jsxs("div",{className:"rounded-lg p-6 max-w-md w-full mx-4",style:{backgroundColor:s.colors.surface,borderColor:s.colors.border,border:"1px solid",boxShadow:s.shadows.xl},children:[o.jsx("h3",{className:"text-lg font-semibold mb-4",style:{color:s.colors.text},children:"确认删除"}),o.jsx("p",{className:"mb-6",style:{color:s.colors.textSecondary},children:"确定要删除这篇文章吗？此操作无法撤销。"}),o.jsxs("div",{className:"flex gap-3 justify-end",children:[o.jsx("button",{onClick:()=>C(!1),className:"px-4 py-2 rounded-lg transition-colors",style:{backgroundColor:s.colors.secondary,color:s.colors.text},onMouseEnter:e=>{e.currentTarget.style.backgroundColor=s.colors.hover},onMouseLeave:e=>{e.currentTarget.style.backgroundColor=s.colors.secondary},children:"取消"}),o.jsx("button",{onClick:F,disabled:p,className:"px-4 py-2 rounded-lg transition-colors",style:{backgroundColor:p?s.colors.secondary:s.colors.error,color:s.colors.text,cursor:p?"not-allowed":"pointer",opacity:p?.7:1},onMouseEnter:e=>{p||(e.currentTarget.style.backgroundColor=s.colors.hover)},onMouseLeave:e=>{p||(e.currentTarget.style.backgroundColor=s.colors.error)},children:p?"删除中...":"删除"})]})]})})]})},ye=()=>o.jsx(oe,{requiredRole:"user",children:o.jsx(ce,{})});export{ye as default};
